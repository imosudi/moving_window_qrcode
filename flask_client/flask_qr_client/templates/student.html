


{% extends "base.html" %}
{% block title %}Student - Scan QR Code{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-white shadow-lg border-light p-4">
        <div class="card-body">
            <h3 class="card-title text-info mb-3">Scan QR Code for Attendance</h3>
            <p class="text-muted mb-4">Scan the QR code provided by the instructor to mark your attendance.</p>
            
            <!-- Start Scanner Button -->
            <div class="text-center mb-4">
                <button id="start-scanner" class="btn btn-primary">
                    üì∑ Start Scanner
                </button>
            </div>
            
            <!-- QR Scanner Container -->
            <div id="qr-reader" class="d-flex justify-content-center mb-4" style="width: 100%; height: 450px;"></div>
            
            <!-- Scan Result -->
            <div id="scan-result" class="text-center text-success mt-4"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script>
    function startScanner() {
        if (typeof Html5Qrcode === "undefined") {
            alert("QR Code scanner library not loaded. Please refresh the page.");
            return;
        }
        
        const scanner = new Html5Qrcode("qr-reader");
        scanner.start(
            { facingMode: "environment" },
            { 
                fps: 10, 
                qrbox: { height: 450, width: 100 },
                rememberLastUsedCamera: true,
            },
            async (decodedText) => {
                //alert("Scanned QR Code:");
                //alert(decodedText);
                document.getElementById("scan-result").innerText = `Scanned: ${decodedText}`;
                await scanner.stop(); // Make sure scanning stops first
                submitAttendance(decodedText); // Then submit the payload
            },
            (error) => {
                console.warn("Scanning error:", error);
            }
        ).catch((err) => {
            console.error("Error starting scanner:", err);
            alert("Error starting QR scanner. Please try again.");
        });
    }

    const GRAPHQL_ENDPOINT = "http://127.0.0.1:8091/graphql_mutation";

    async function submitAttendance(scannedPayload) {
    alert("Calling validateAttendance with: " + scannedPayload);
    try {
        const graphqlQuery = {
            query: `
                mutation ValidateAttendance($payload: String!, $studentId: String!) {
                    validateAttendance(
                        encryptedPayload: $payload,
                        studentId: $studentId
                    )
                }
            `,
            variables: {
                payload: scannedPayload,
                studentId: "STU456"
            }
        };

        const response = await fetch(GRAPHQL_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(graphqlQuery),
        });

        const raw = await response.text();
        console.log("Raw GraphQL Response:", raw);

        const result = JSON.parse(raw);
        const parsed = JSON.parse(result.data.validateAttendance);

        if (parsed.status === "SUCCESS") {
            alert("‚úÖ Attendance recorded successfully!");
        } else {
            alert("‚ùå Attendance error: " + parsed.message);
        }
    } catch (error) {
        console.error("Error submitting attendance:", error);
        alert("üö® Error submitting attendance. Please try again.");
    }
}

    // Initialize the scanner when the page is ready
    document.getElementById("start-scanner").addEventListener("click", startScanner);
</script>
{% endblock %}